var y = Object.defineProperty;
var P = (n, t, e) => t in n ? y(n, t, { enumerable: !0, configurable: !0, writable: !0, value: e }) : n[t] = e;
var h = (n, t, e) => P(n, typeof t != "symbol" ? t + "" : t, e);
import { SETUP_ENDPOINT_PATH as u, SETUP_ENDPOINTS_API_VERSIONS as E } from "./constants.js";
import { parseSearchParams as g } from "../../Http/utils.js";
import { encodeAnalyticsEvent as x } from "../../Analytics/analytics/utils.js";
import { noop as _, deepFreeze as v } from "../../../utils/common.js";
import { EMPTY_OBJECT as o } from "../../../utils/value/constants.js";
import { createPromisor as T } from "../../../primitives/async/promisor/main.js";
import { struct as b, withFreezeProxyHandlers as O, asPlainObject as S } from "../../../utils/struct/main.js";
import { isPlainObject as k, isUndefined as C } from "../../../utils/value/is.js";
import { isAbortSignal as w, abortSignalForAny as A } from "../../../utils/abort/main.js";
class V {
  constructor(t) {
    h(this, "_endpoints", o);
    h(this, "_extraConfig", o);
    h(this, "_revokeEndpointsProxy", _);
    h(this, "_beforeHttp", async () => {
      await this._refreshPromisor.promise.catch(_);
    });
    h(this, "_refreshPromisor", T((t, e) => {
      const r = w(e) ? A([e, t]) : t;
      return this._fetchSetupEndpoint(r);
    }));
    this._session = t;
    let e;
    this.refresh = (r) => (this._refreshPromisor(r).catch(_), e ?? (e = this._refreshPromisor.promise.finally(() => e = void 0).then(({ endpoints: c, ...s }) => {
      var i;
      this._resetEndpoints(), { proxy: this._endpoints, revoke: this._revokeEndpointsProxy } = this._getEndpointsProxy(c), this._extraConfig = v(s), this.analyticsEnabled && ((i = this._setAnalyticsUserProfile()) == null || i.then(() => {
        this.setCustomTranslationsAnalytics();
      }));
    })));
  }
  get endpoints() {
    return this._endpoints;
  }
  get extraConfig() {
    return this._extraConfig;
  }
  _fetchSetupEndpoint(t) {
    return this._session.http(null, {
      method: "POST",
      path: u,
      errorLevel: "fatal",
      loadingContext: this.loadingContext,
      signal: t
    });
  }
  async _setAnalyticsUserProfile() {
    const t = x([{}]);
    if (this._endpoints.sendEngageEvent && t)
      return this._endpoints.sendEngageEvent(
        {
          body: t,
          contentType: "application/x-www-form-urlencoded",
          keepalive: !0
        },
        o
      );
  }
  async setCustomTranslationsAnalytics() {
    var t;
    if (this.analyticsPayload && ((t = this.analyticsPayload) == null ? void 0 : t.length) > 0 && this._endpoints && this._endpoints.sendTrackEvent) {
      const e = [];
      Promise.all(
        this.analyticsPayload.map((r) => this._endpoints.sendTrackEvent(
          {
            body: r,
            contentType: "application/x-www-form-urlencoded",
            keepalive: !0
          },
          o
        ).catch(() => {
          e.push(r);
        }))
      ).finally(() => {
        this.analyticsPayload = e.length > 0 ? e : void 0;
      });
    }
  }
  _getEndpointsProxy(t) {
    const e = new Set(Object.keys(t)), r = b();
    return Proxy.revocable(
      o,
      O({
        get: (c, s, i) => {
          if (!e.has(s))
            return Reflect.get(c, s, i);
          const a = E[s], l = a ? { apiVersion: a } : o;
          return r[s] ?? (r[s] = (() => {
            const { method: d = "GET", url: p } = t[s];
            if (!C(p || void 0))
              return (...f) => {
                const m = {
                  ...this._getHttpOptions(d, p, ...f),
                  ...l
                };
                return this._session.http(this._beforeHttp, m);
              };
          })()), r[s];
        }
      })
    );
  }
  _getHttpOptions(t, e, ...r) {
    const { loadingContext: c } = this, [s, i] = r, { path: a, query: l } = S(i), d = l && g(l);
    if (k(a))
      for (const p of Object.keys(a))
        e = e.replace(`{${p}}`, a[p]);
    return { loadingContext: c, ...s, method: t, params: d, path: e };
  }
  _resetEndpoints() {
    this._revokeEndpointsProxy(), this._revokeEndpointsProxy = _, this._endpoints = o;
  }
}
export {
  V as SetupContext,
  V as default
};
