import { useRef as o, useMemo as E, useCallback as c } from "../../external/preact/hooks/dist/hooks.module.js";
import { InteractionKeyCode as n } from "../../components/types.js";
import { withTabbableRoot as H, focusIsWithin as i, isFocusable as I } from "../../primitives/dom/tabbableRoot/tabbable.js";
import M from "../useReflex.js";
import { isUndefined as O } from "../../utils/value/is.js";
const q = (k, A) => {
  const u = o(!1), l = o(null), f = o(!1), T = o(null), d = o(1), b = o(!1), r = E(H, []), F = c((e) => {
    const t = l.current;
    if (t instanceof HTMLElement && i(e, t)) {
      t.focus();
      return;
    }
    e instanceof HTMLElement && e.focus();
  }, []), L = E(() => {
    let e = null, t;
    return (m) => {
      O(t) || cancelAnimationFrame(t);
      let s = m.target;
      for (; s && s !== m.currentTarget; ) {
        if (I(s)) {
          e = s, t = requestAnimationFrame(() => {
            t = requestAnimationFrame(() => {
              var a;
              l.current !== e && e instanceof HTMLElement && ((a = l.current = e) == null || a.focus()), e = null, t = void 0;
            });
          });
          return;
        }
        s = s.parentNode;
      }
    };
  }, []), R = c((e) => {
    r.current = l.current = e.target;
  }, []), g = c((e) => {
    var s;
    const t = r.root;
    if (!(t instanceof Element)) return;
    const m = e.target;
    if (!i(t, m) && i(t, e.relatedTarget) && f.current && T.current === n.TAB) {
      const a = r.tabbables;
      if (a.length) {
        const x = d.current === -1 ? a.length - 1 : 0;
        (s = a[x]) == null || s.focus();
      } else
        F(t);
    }
  }, []), h = c((e) => {
    r.tabbables.includes(e.relatedTarget) || i(e.currentTarget, e.relatedTarget) || f.current || (u.current = !0, requestAnimationFrame(() => {
      u.current && A(u.current = !1);
    }));
  }, []), C = E(() => {
    let e;
    return (t) => {
      switch (T.current = t.code, t.code) {
        case n.ARROW_DOWN:
        case n.ARROW_LEFT:
        case n.ARROW_RIGHT:
        case n.ARROW_UP:
        case n.END:
        case n.ESCAPE:
        case n.HOME:
        case n.PAGE_DOWN:
        case n.PAGE_UP:
        case n.TAB:
          cancelAnimationFrame(e), e = requestAnimationFrame(() => {
            e = requestAnimationFrame(() => {
              f.current = !1, e = void 0;
            });
          }), f.current = !0;
          break;
      }
      t.code === n.TAB ? (t.preventDefault(), d.current = t.shiftKey ? -1 : 1, r.tabbables.length ? r.current = d.current : r.root instanceof Element && F(r.root)) : t.code === n.ESCAPE && A(!0);
    };
  }, []);
  return M(
    c((e, t) => {
      t instanceof Element && (t.removeEventListener("keydown", C, !0), t.removeEventListener("focusin", R, !0), t.removeEventListener("focusout", h, !1), t.removeEventListener("click", L, !0), document.removeEventListener("focusin", g, !0), b.current && t instanceof HTMLElement && (t.removeAttribute("tabindex"), b.current = !1)), e instanceof Element ? (e.addEventListener("keydown", C, !0), e.addEventListener("focusin", R, !0), e.addEventListener("focusout", h, !1), e.addEventListener("click", L, !0), document.addEventListener("focusin", g, !0), u.current = !1, r.root = e, e instanceof HTMLElement && !e.hasAttribute("tabindex") && (e.setAttribute("tabindex", "-1"), b.current = !0), i(e, document.activeElement) || e instanceof HTMLElement && e.focus()) : r.root = null;
    }, []),
    k
  );
};
export {
  q as default
};
