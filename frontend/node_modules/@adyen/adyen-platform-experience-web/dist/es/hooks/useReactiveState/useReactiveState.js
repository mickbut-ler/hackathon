import { useRef as o, useMemo as j, useReducer as v, useEffect as w } from "../../external/preact/hooks/dist/hooks.module.js";
import P from "../useMounted.js";
import { EMPTY_OBJECT as R } from "../../utils/value/constants.js";
const x = (a = R, f = !0) => {
  const n = o(f), e = o(Object.freeze({ ...a })), S = o(new Set(Object.keys(e.current))), u = o(/* @__PURE__ */ new Set()), h = P(), [d, z] = j(() => {
    const r = (c) => {
      h.current && T(c);
    };
    return [
      () => r("reset"),
      (c) => r(c)
    ];
  }, [h]), [E, T] = v((r, c) => {
    if (c === "reset")
      return u.current.clear(), e.current;
    const s = { ...c }, l = [0];
    Object.keys(s).forEach((t, m) => {
      if (!S.current.has(t)) return;
      const g = r[t] ?? void 0, O = e.current[t] ?? void 0, p = s[t] ?? O;
      if (p === g) return;
      const b = Math.floor(m / 32), M = 1 << m % 32;
      s[t] = p, l[b] = (l[b] ?? 0) | M, u.current[p === O ? "delete" : "add"](t);
    });
    const i = l.some((t) => t) ? n.current && u.current.size === 0 ? e.current : Object.freeze({ ...r, ...s }) : r;
    return n.current || (e.current = i, n.current = !0), i;
  }, e.current), $ = j(() => !!u.current.size, []);
  return w(() => {
    e.current = Object.freeze({ ...a }), S.current = new Set(Object.keys(e.current)), n.current = f, d();
  }, [f, a, d]), { canResetState: $, defaultState: e.current, resetState: d, state: E, updateState: z };
};
export {
  x as default
};
